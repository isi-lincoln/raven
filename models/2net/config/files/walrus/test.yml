---

- hosts: n0

  tasks:
    - name: clear existing pingtests
      command: pkill -f pingtest -9
      ignore_errors: yes
      tags:
        - vpath-create

    - name: ping test
      shell: /tmp/config/pingtest.sh 10.47.0.2 vpath-create >> /tmp/pingtest
      async: 3600
      poll: 0
      tags:
        - vpath-create

- hosts: n1

  tasks:
    - name: clear existing pingtests
      command: pkill -f pingtest -9
      ignore_errors: yes
      tags:
        - vpath-create

    - name: ping test
      shell: /tmp/config/pingtest.sh 10.47.0.1 vpath-create >> /tmp/pingtest
      async: 3600
      poll: 0
      tags:
        - vpath-create

- hosts: control

  tasks:
    - name: create virtual path
      shell: sleep 4 && /opt/switch-drivers/snmp/apps/snmp nimbus vlan port 3 4 set access 2001
      async: 3600
      poll: 0
      tags:
        - vpath-create
    
    - name: destroy virtual path
      shell: "{{item}}"
      async: 3600
      poll: 0
      tags:
        - vpath-destroy
      with_items:
        - sleep 7 && /opt/switch-drivers/snmp/apps/snmp nimbus vlan port 3 4 clear
        - sleep 7 && /opt/switch-drivers/snmp/apps/snmp nimbus vlan port 3 set access 3
        - sleep 7 && /opt/switch-drivers/snmp/apps/snmp nimbus vlan port 4 set access 4
